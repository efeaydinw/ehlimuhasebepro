<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ehlizade Muhasebe ‚Äì Pro</title>
<meta name="theme-color" content="#225c0a"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { theme:{ extend:{ colors:{ primary:'#225c0a', accent:'#e17703', dark:'#0f140f', soft:'#161d16', border:'#233e1a' } } } }
</script>
<style>
  body{background:#0f140f;color:#eef0ee;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .card{background:#161d16;border:1px solid #233e1a;border-radius:16px}
  .btn{background:#225c0a;border-radius:12px;padding:12px 18px;font-weight:800}
  .btn:hover{filter:brightness(1.08)}
  .btn-sec{background:#1b221b}
  .inp{background:#121812;border:1px solid #225c0a;border-radius:12px;padding:14px 16px;width:100%}
  .chip{border:1px solid #225c0a;border-radius:9999px;padding:10px 16px;cursor:pointer;font-weight:700}
  .chip.active{background:#e17703;color:#000;border-color:#e17703}
  .badge{border:1px solid #225c0a;background:#1a2418;border-radius:9999px;padding:4px 10px;font-size:12px}
  .toast{position:fixed;right:16px;bottom:16px;display:none}
  .toast.show{display:block;animation:fadein .2s}@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .tbl th{background:#1b221b}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header class="border-b border-border/60 bg-soft/60 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <div class="w-9 h-9 rounded-xl bg-primary grid place-items-center font-black">E</div>
    <div class="text-lg font-black tracking-wide text-accent">Ehlizade Muhasebe</div>
    <div class="ml-auto flex items-center gap-2 text-sm">
      <span id="roleBadge" class="badge hidden"></span>
      <button id="adminBtn" class="btn btn-sec hidden">Y√∂netim</button>
      <button id="logoutBtn" class="btn btn-sec hidden">√áƒ±kƒ±≈ü</button>
    </div>
  </div>
</header>

<!-- Toast -->
<div id="toast" class="toast"><div id="toastBox" class="card p-3 text-sm"></div></div>

<!-- LOGIN (sadece ≈üifre) -->
<section id="authSection" class="max-w-sm mx-auto p-4">
  <div class="card p-8">
    <div class="text-center mb-6">
      <div class="inline-grid place-items-center w-12 h-12 rounded-2xl bg-primary/80 font-black">E</div>
      <h1 class="text-2xl font-black text-accent mt-2">Giri≈ü</h1>
      <p class="text-xs opacity-75">Sadece ≈üifre yaz ve gir.</p>
    </div>
    <label class="block mb-2 text-sm opacity-80">≈ûifre</label>
    <input id="onlyPass" type="password" class="inp mb-3" placeholder="Y√∂netici: 123456 | Kasiyer: 1234567"/>
    <div class="flex gap-2">
      <button id="loginBtn" class="btn w-full">Giri≈ü</button>
      <button id="showPw" class="btn btn-sec" title="G√∂ster">üëÅ</button>
    </div>
    <p id="firstSetup" class="text-xs opacity-70 mt-4 hidden">
      Giri≈ü olmuyorsa <b>ƒ∞lk Kurulum</b> yap:
      <button id="initBtn" class="btn btn-sec mt-2 w-full">ƒ∞lk Kurulum: Y√∂netici(123456) + Kasiyer(1234567)</button>
    </p>
  </div>
</section>

<!-- APP -->
<main id="appSection" class="hidden max-w-6xl mx-auto p-4 pb-16">
  <div class="flex gap-2 mb-4">
    <button data-tab="today"   class="tab btn">Bug√ºn</button>
    <button data-tab="expense" class="tab btn">Gider</button>
    <button data-tab="history" class="tab btn">Ge√ßmi≈ü</button>
    <button data-tab="report"  class="tab btn">Rapor</button>
  </div>

  <!-- TODAY -->
  <section id="tab-today" class="space-y-4">
    <div class="card p-4">
      <h3 class="text-accent font-extrabold text-lg mb-3">Gelir Kaydƒ±</h3>
      <div class="grid md:grid-cols-5 gap-3">
        <div><label class="block mb-1 text-sm opacity-80">Tutar (‚Ç∫)</label><input id="incAmount" type="number" step="0.01" min="0" class="inp" placeholder="0,00"/></div>
        <div class="md:col-span-2"><label class="block mb-1 text-sm opacity-80">√ñdeme</label>
          <div class="flex gap-2">
            <button id="incCash" class="chip active" data-val="cash">NAKƒ∞T</button>
            <button id="incCard" class="chip"        data-val="card">KART</button>
          </div>
        </div>
        <div><label class="block mb-1 text-sm opacity-80">Personel</label><input id="incStaff" class="inp" placeholder="(opsiyonel)"/></div>
        <div><label class="block mb-1 text-sm opacity-80">Not</label><input id="incNote" class="inp" placeholder="(opsiyonel)"/></div>
      </div>
      <div class="mt-3"><button id="saveIncome" class="btn">Kaydet</button></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center gap-3 mb-3"><h4 class="font-bold">Bug√ºnk√º Gelirler</h4><div id="incTotals" class="ml-auto text-sm opacity-80">Nakit: ‚Ç∫0,00 | Kart: ‚Ç∫0,00 | Toplam: ‚Ç∫0,00</div></div>
      <div class="overflow-auto">
        <table class="tbl w-full text-sm"><thead><tr class="text-left">
          <th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th><th class="p-2 w-28">ƒ∞≈ülem</th>
        </tr></thead><tbody id="incBody"></tbody></table>
      </div>
    </div>
  </section>

  <!-- EXPENSE -->
  <section id="tab-expense" class="hidden space-y-4">
    <div class="card p-4">
      <h3 class="text-accent font-extrabold text-lg mb-3">Gider Kaydƒ±</h3>
      <div class="grid md:grid-cols-5 gap-3">
        <div><label class="block mb-1 text-sm opacity-80">Tutar (‚Ç∫)</label><input id="expAmount" type="number" step="0.01" min="0" class="inp" placeholder="0,00"/></div>
        <div class="md:col-span-2"><label class="block mb-1 text-sm opacity-80">√ñdeme</label>
          <div class="flex gap-2">
            <button id="expCash" class="chip active" data-val="cash">NAKƒ∞T</button>
            <button id="expCard" class="chip"        data-val="card">KART</button>
          </div>
        </div>
        <div><label class="block mb-1 text-sm opacity-80">Personel</label><input id="expStaff" class="inp" placeholder="(opsiyonel)"/></div>
        <div><label class="block mb-1 text-sm opacity-80">Not</label><input id="expNote" class="inp" placeholder="(opsiyonel)"/></div>
      </div>
      <div class="mt-3"><button id="saveExpense" class="btn">Kaydet</button></div>
    </div>

    <div class="card p-4">
      <div class="flex items-center gap-3 mb-3"><h4 class="font-bold">Bug√ºnk√º Giderler</h4><div id="expTotals" class="ml-auto text-sm opacity-80">Nakit: ‚Ç∫0,00 | Kart: ‚Ç∫0,00 | Toplam: ‚Ç∫0,00</div></div>
      <div class="overflow-auto">
        <table class="tbl w-full text-sm"><thead><tr class="text-left">
          <th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th><th class="p-2 w-28">ƒ∞≈ülem</th>
        </tr></thead><tbody id="expBody"></tbody></table>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="tab-history" class="hidden space-y-4">
    <div class="card p-4">
      <div class="flex items-end gap-3">
        <div><label class="block mb-1 text-sm opacity-80">Tarih</label><input id="histDate" type="date" class="inp"/></div>
        <button id="loadHistory" class="btn">Y√ºkle</button>
        <div id="histTotals" class="ml-auto text-sm opacity-80">Gelir: ‚Ç∫0,00 | Gider: ‚Ç∫0,00 | Fark: ‚Ç∫0,00</div>
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4"><h4 class="font-bold mb-2">Gelir</h4><div class="overflow-auto"><table class="tbl w-full text-sm">
        <thead><tr><th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th></tr></thead><tbody id="histInc"></tbody>
      </table></div></div>
      <div class="card p-4"><h4 class="font-bold mb-2">Gider</h4><div class="overflow-auto"><table class="tbl w-full text-sm">
        <thead><tr><th class="p-2">Saat</th><th class="p-2">Y√∂ntem</th><th class="p-2">Tutar</th><th class="p-2">Personel</th><th class="p-2">Not</th></tr></thead><tbody id="histExp"></tbody>
      </table></div></div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="tab-report" class="hidden">
    <div class="card p-4">
      <h3 class="text-accent font-extrabold mb-3">G√ºn Sonu Raporu (Br√ºt)</h3>
      <div id="repLines" class="space-y-1 text-sm"></div>
      <button id="refreshReport" class="btn mt-3">Yenile</button>
    </div>
  </section>
</main>

<!-- ADMIN (modal) -->
<div id="adminModal" class="modal">
  <div class="card w-[min(900px,98vw)] p-6">
    <div class="flex items-center mb-4">
      <h3 class="text-xl font-extrabold text-accent">Y√∂netim Paneli</h3>
      <button id="closeAdmin" class="ml-auto btn btn-sec">Kapat</button>
    </div>

    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <h4 class="font-bold mb-2">Kullanƒ±cƒ±lar</h4>
        <div class="overflow-auto">
          <table class="tbl w-full text-sm">
            <thead><tr><th class="p-2">Email</th><th class="p-2">Rol</th><th class="p-2">Olu≈üturma</th><th class="p-2 w-40">ƒ∞≈ülem</th></tr></thead>
            <tbody id="userBody"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h4 class="font-bold mb-2">≈ûifreler</h4>
        <div class="card p-3 mb-3">
          <div class="text-sm">Y√∂netici ≈ûifresi: <b id="adminPassLabel">‚Äî</b></div>
          <div class="mt-2 flex gap-2">
            <input id="adminPassNew" class="inp" placeholder="Yeni ≈üifre (6+ karakter)"/>
            <button id="adminPassSet" class="btn">Deƒüi≈ütir</button>
          </div>
        </div>
        <div class="card p-3">
          <div class="text-sm">Kasiyer ≈ûifresi: <b id="cashierPassLabel">‚Äî</b></div>
          <div class="mt-2 flex gap-2">
            <input id="cashierPassNew" class="inp" placeholder="Yeni ≈üifre (6+ karakter)"/>
            <button id="cashierPassSet" class="btn">Deƒüi≈ütir</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ================== AYAR ================== */
const SUPABASE_URL      = 'https://vliakqhncjsqmrupopja.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsaWFrcWhuY2pzcW1ydXBvcGphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MzE5NTEsImV4cCI6MjA3MzUwNzk1MX0.AI0_9Yb1KAWaRNRMIEAe1LG4smZ-kUvUk2gF-h2E-dk';
/* ========================================= */
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $=(id)=>document.getElementById(id);
const show=(id,on=true)=>$(id).classList.toggle('hidden',!on);
const toast=(m,ok=true)=>{const t=$('toast'),b=$('toastBox');b.textContent=m;b.style.borderColor=ok?'#2e8b57':'#a33';b.style.background=ok?'#163c20':'#441818';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)};
const fmt=(n)=>new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n||0));
const todayStr=()=>new Date().toISOString().slice(0,10);
const timeStr=(iso)=>new Date(iso).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});

let profile=null;
let TENANT_ID=null;

function chipGroup(a,b){a.classList.add('active');a.onclick=()=>{a.classList.add('active');b.classList.remove('active')};b.onclick=()=>{b.classList.add('active');a.classList.remove('active')};}

/* === LOGIN (sadece ≈üifre) === */
$('showPw').onclick=()=>{const i=$('onlyPass');i.type=i.type==='password'?'text':'password'};

$('loginBtn').onclick=async()=>{
  const pass=$('onlyPass').value.trim();
  if(!pass){ toast('≈ûifre gir',false); return; }

  let ok=false;
  let res = await supa.auth.signInWithPassword({ email:'admin@local.local', password: pass });
  if(!res.error) ok=true;
  if(!ok){
    res = await supa.auth.signInWithPassword({ email:'cashier@local.local', password: pass });
    if(!res.error) ok=true;
  }
  if(!ok){
    $('firstSetup').classList.remove('hidden'); // ba≈üarƒ±sƒ±zsa kurulum butonu g√∂r√ºn√ºr
    toast('Giri≈ü ba≈üarƒ±sƒ±z',false);
    return;
  }
  await afterLogin();
};

/* === ƒ∞lk Kurulum: 6+ karakter ≈üifre ≈üart === */
$('initBtn').onclick=async()=>{
  await supa.auth.signUp({ email:'admin@local.local',  password:'123456'  });
  await supa.auth.signUp({ email:'cashier@local.local', password:'1234567' });
  toast('Kurulum tamam. Y√∂netici: 123456 | Kasiyer: 1234567',true);
};

/* === √áƒ±kƒ±≈ü === */
$('logoutBtn').onclick=async()=>{ await supa.auth.signOut(); location.reload(); };

/* === Uygulama ba≈ülat === */
async function afterLogin(){
  // Sunucuda sistem kendi kendini toparlasƒ±n: tenant/settings/profil -> olu≈ütur + d√∂n
  const boot = await supa.rpc('ensure_current_profile');
  if(boot.error){ toast('Sunucu hazƒ±rlƒ±ƒüƒ± hata: '+boot.error.message,false); return; }
  TENANT_ID = boot.data?.[0]?.tenant_id || boot.data?.tenant_id || null;
  const role_from_rpc = boot.data?.[0]?.role || boot.data?.role || null;
  if(!TENANT_ID){ toast('Tenant ID alƒ±namadƒ±', false); return; }

  // Profilini √ßek (kendi satƒ±rƒ±nƒ± g√∂rebilir)
  const me = await supa.from('profiles').select('id,role,tenant_id,email,created_at').eq('id',(await supa.auth.getUser()).data.user.id).single();
  if(me.error && !role_from_rpc){ toast('Profil bulunamadƒ±', false); return; }
  profile = me.data || { role: role_from_rpc, tenant_id: TENANT_ID };

  // UI
  show('authSection',false); show('appSection',true); show('logoutBtn',true);
  $('roleBadge').textContent = profile.role==='owner'?'Y√∂netici':'Kasiyer';
  show('roleBadge',true); show('adminBtn', profile.role==='owner');

  // Tablar
  document.querySelector('[data-tab="today"]').onclick=()=>{document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));$('tab-today').classList.remove('hidden');};
  document.querySelector('[data-tab="expense"]').onclick=()=>{document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));$('tab-expense').classList.remove('hidden');};
  document.querySelector('[data-tab="history"]').onclick=()=>{document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));$('tab-history').classList.remove('hidden');};
  document.querySelector('[data-tab="report"]').onclick=()=>{document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));$('tab-report').classList.remove('hidden');};
  document.querySelector('[data-tab="today"]').click();

  chipGroup(document.getElementById('incCash'),document.getElementById('incCard'));
  chipGroup(document.getElementById('expCash'),document.getElementById('expCard'));
  document.getElementById('histDate').value=todayStr();

  await loadToday(); await loadExpenseToday(); await loadHistory(); await refreshReport();
}

/* === Y√∂netim Paneli (sadece Y√∂netici) === */
$('adminBtn').onclick=async()=>{ await refreshUsers(); await loadSettings(); $('adminModal').classList.add('show'); };
$('closeAdmin').onclick=()=>$('adminModal').classList.remove('show');

async function refreshUsers(){
  const { data, error } = await supa.from('profiles')
    .select('id,email,role,created_at')
    .eq('tenant_id', TENANT_ID)
    .order('created_at',{ascending:true});
  if(error){ toast('Kullanƒ±cƒ±lar alƒ±namadƒ±: '+error.message,false); return; }

  $('userBody').innerHTML=(data||[]).map(u=>`<tr class="odd:bg-soft">
    <td class="p-2">${u.email||'‚Äî'}</td>
    <td class="p-2">${u.role==='owner'?'Y√∂netici':'Kasiyer'}</td>
    <td class="p-2">${new Date(u.created_at).toLocaleString('tr-TR')}</td>
    <td class="p-2">
      ${u.email==='admin@local.local'?'':`<button class="btn btn-sec text-xs" data-reset="${u.email}">≈ûifre Sƒ±fƒ±rla</button>`}
    </td>
  </tr>`).join('');

  // ≈ûifre sƒ±fƒ±rla
  document.querySelectorAll('[data-reset]').forEach(b=>{
    b.onclick=async()=>{
      const email=b.getAttribute('data-reset');
      const newPass=prompt(`${email} i√ßin yeni ≈üifre (6+ karakter)?`); if(!newPass) return;

      // Y√∂netici oturumunu sakla
      const prev=(await supa.auth.getSession())?.data?.session;
      if(!prev){ toast('Oturum yok',false); return; }

      // Eski ≈üifreyi settings'ten √ßek
      let oldPass=null;
      if(email==='cashier@local.local'){
        const s = await supa.from('settings').select('cashier_pass').eq('tenant_id',TENANT_ID).single();
        oldPass = s.data?.cashier_pass;
      } else if (email==='admin@local.local'){
        const s = await supa.from('settings').select('admin_pass').eq('tenant_id',TENANT_ID).single();
        oldPass = s.data?.admin_pass;
      } else {
        oldPass = prompt('Eski ≈üifre?'); if(!oldPass) return;
      }

      // Ge√ßici giri≈ü ‚Üí ≈üifre deƒüi≈ütir ‚Üí geri d√∂n
      const { error:e1 } = await supa.auth.signInWithPassword({ email, password: oldPass });
      if(e1){ toast('Ge√ßici giri≈ü hata: '+e1.message,false); return; }
      const { error:e2 } = await supa.auth.updateUser({ password:newPass });
      if(e2){ toast('≈ûifre deƒüi≈ümedi: '+e2.message,false); return; }

      // settings senkron
      if(email==='cashier@local.local'){
        await supa.from('settings').update({ cashier_pass:newPass, updated_at:new Date().toISOString() }).eq('tenant_id',TENANT_ID);
      }
      if(email==='admin@local.local'){
        await supa.from('settings').update({ admin_pass:newPass, updated_at:new Date().toISOString() }).eq('tenant_id',TENANT_ID);
      }

      // Y√∂netici oturumuna geri d√∂n
      const { error:e3 } = await supa.auth.setSession({ access_token: prev.access_token, refresh_token: prev.refresh_token });
      if(e3){ toast('Y√∂netici oturumu d√∂nmedi: '+e3.message,false); return; }

      toast('≈ûifre g√ºncellendi'); await loadSettings();
    };
  });
}

async function loadSettings(){
  const { data, error } = await supa.from('settings')
    .select('admin_pass,cashier_pass').eq('tenant_id',TENANT_ID).single();
  if(error){ $('adminPassLabel').textContent='‚Äî'; $('cashierPassLabel').textContent='‚Äî'; return; }
  $('adminPassLabel').textContent = data.admin_pass;
  $('cashierPassLabel').textContent = data.cashier_pass;
}

$('adminPassSet').onclick=async()=>{
  const newPass=$('adminPassNew').value.trim(); if(!newPass || newPass.length<6){toast('6+ karakter gir',false);return;}
  const { error:e1 } = await supa.auth.updateUser({ password:newPass });
  if(e1){ toast('≈ûifre deƒüi≈ümedi: '+e1.message,false); return; }
  await supa.from('settings').update({ admin_pass:newPass, updated_at:new Date().toISOString() }).eq('tenant_id',TENANT_ID);
  $('adminPassNew').value=''; toast('Y√∂netici ≈üifresi g√ºncellendi'); await loadSettings();
};

$('cashierPassSet').onclick = async () => {
  const newPass = $('cashierPassNew').value.trim();
  if (!newPass || newPass.length < 6) { toast('6+ karakter gir', false); return; }

  // 1) Mevcut kasiyer ≈üifresini settings'ten al
  const s = await supa.from('settings').select('cashier_pass').eq('tenant_id', TENANT_ID).single();
  const oldPass = s.data?.cashier_pass;
  if (!oldPass) { toast('Mevcut kasiyer ≈üifresi bulunamadƒ±', false); return; }

  // 2) Ge√ßici client (admin oturumunu bozmaz) ‚Äî API KEY HEADERS EKLƒ∞!
  const temp = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      auth: { persistSession: false, autoRefreshToken: false },
      global: {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`
        }
      }
    }
  );

  // 3) Kasiyer olarak kƒ±sa s√ºreli giri≈ü yap
  const si = await temp.auth.signInWithPassword({ email: 'cashier@local.local', password: oldPass });
  if (si.error) { toast('Kasiyer giri≈üi hata: ' + si.error.message, false); return; }

  // 4) Kendi ≈üifresini g√ºncelle
  const up = await temp.auth.updateUser({ password: newPass });
  if (up.error) { toast('≈ûifre deƒüi≈ümedi: ' + up.error.message, false); return; }

  // 5) √áƒ±kƒ±≈ü yap ve settings‚Äôi senkronla
  await temp.auth.signOut();
  await supa.from('settings')
    .update({ cashier_pass: newPass, updated_at: new Date().toISOString() })
    .eq('tenant_id', TENANT_ID);

  $('cashierPassNew').value = '';
  toast('Kasiyer ≈üifresi g√ºncellendi');
  await loadSettings();
};


/* === Kayƒ±t i≈ülemleri === */
function rowActions(id){return `<button class="btn btn-sec text-xs" data-del="${id}">üóë Sil</button>`;}
function bindDeleteHandlers(containerId, reloadFn){
  document.querySelectorAll('#'+containerId+' [data-del]').forEach(b=>{
    b.onclick=async()=>{
      if(!confirm('Kayƒ±t silinsin mi?'))return;
      const { error } = await supa.from('entries').delete().eq('id',b.getAttribute('data-del')).eq('tenant_id',TENANT_ID);
      if(error){toast('Silinemedi: '+error.message,false);return;}
      toast('Silindi'); await reloadFn();
    };
  });
}

async function loadToday(){
  const { data, error } = await supa.from('entries').select('id,method,amount,staff,note,at_time')
    .eq('tenant_id',TENANT_ID).eq('kind','income').eq('at_date',todayStr()).order('id',{ascending:false});
  if(error){toast(error.message,false);return;}
  const rows=data||[];
  $('incBody').innerHTML=rows.map(r=>`<tr class="odd:bg-soft">
    <td class="p-2">${timeStr(r.at_time)}</td><td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td>
    <td class="p-2">‚Ç∫${fmt(r.amount)}</td><td class="p-2">${r.staff||''}</td><td class="p-2">${r.note||''}</td>
    <td class="p-2">${rowActions(r.id)}</td></tr>`).join('');
  bindDeleteHandlers('incBody', loadToday);
  let c=0,k=0; rows.forEach(r=>r.method==='cash'?c+=+r.amount:k+=+r.amount);
  $('incTotals').textContent=`Nakit: ‚Ç∫${fmt(c)} | Kart: ‚Ç∫${fmt(k)} | Toplam: ‚Ç∫${fmt(c+k)}`;
}

document.getElementById('saveIncome').onclick=async()=>{
  const amount=Number(document.getElementById('incAmount').value);
  if(!amount||amount<=0){toast('Ge√ßerli tutar gir',false);return;}
  const method=document.getElementById('incCash').classList.contains('active')?'cash':'card';
  const staff=document.getElementById('incStaff').value.trim()||null;
  const note=document.getElementById('incNote').value.trim()||null;
  const {error}=await supa.from('entries').insert({tenant_id:TENANT_ID,kind:'income',method,amount,staff,note});
  if(error){toast(error.message,false);return;}
  document.getElementById('incAmount').value='';document.getElementById('incNote').value='';toast('Gelir eklendi');await loadToday();
};

async function loadExpenseToday(){
  const { data, error } = await supa.from('entries').select('id,method,amount,staff,note,at_time')
    .eq('tenant_id',TENANT_ID).eq('kind','expense').eq('at_date',todayStr()).order('id',{ascending:false});
  if(error){toast(error.message,false);return;}
  const rows=data||[];
  $('expBody').innerHTML=rows.map(r=>`<tr class="odd:bg-soft">
    <td class="p-2">${timeStr(r.at_time)}</td><td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td>
    <td class="p-2">‚Ç∫${fmt(r.amount)}</td><td class="p-2">${r.staff||''}</td>
    <td class="p-2">${r.note||''}</td><td class="p-2">${rowActions(r.id)}</td></tr>`).join('');
  bindDeleteHandlers('expBody', loadExpenseToday);
  let c=0,k=0; rows.forEach(r=>r.method==='cash'?c+=+r.amount:k+=+r.amount);
  $('expTotals').textContent=`Nakit: ‚Ç∫${fmt(c)} | Kart: ‚Ç∫${fmt(k)} | Toplam: ‚Ç∫${fmt(c+k)}`;
}

document.getElementById('saveExpense').onclick=async()=>{
  const amount=Number(document.getElementById('expAmount').value);
  if(!amount||amount<=0){toast('Ge√ßerli tutar gir',false);return;}
  const method=document.getElementById('expCash').classList.contains('active')?'cash':'card';
  const staff=document.getElementById('expStaff').value.trim()||null;
  const note=document.getElementById('expNote').value.trim()||null;
  const {error}=await supa.from('entries').insert({tenant_id:TENANT_ID,kind:'expense',method,amount,staff,note});
  if(error){toast(error.message,false);return;}
  document.getElementById('expAmount').value='';document.getElementById('expNote').value='';toast('Gider eklendi');await loadExpenseToday();
};

/* HISTORY */
document.getElementById('loadHistory').onclick=loadHistory;
async function loadHistory(){
  const d=document.getElementById('histDate').value||todayStr();
  const base=supa.from('entries').select('method,amount,staff,note,at_time').eq('tenant_id',TENANT_ID).eq('at_date',d);
  const [inc,exp]=await Promise.all([base.eq('kind','income').order('id',{ascending:false}),base.eq('kind','expense').order('id',{ascending:false})]);
  const incRows=inc.data||[], expRows=exp.data||[];
  $('histInc').innerHTML=incRows.map(r=>`<tr class="odd:bg-soft"><td class="p-2">${timeStr(r.at_time)}</td><td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td><td class="p-2">‚Ç∫${fmt(r.amount)}</td><td class="p-2">${r.staff||''}</td><td class="p-2">${r.note||''}</td></tr>`).join('');
  $('histExp').innerHTML=expRows.map(r=>`<tr class="odd:bg-soft"><td class="p-2">${timeStr(r.at_time)}</td><td class="p-2">${r.method==='cash'?'Nakit':'Kart'}</td><td class="p-2">‚Ç∫${fmt(r.amount)}</td><td class="p-2">${r.staff||''}</td><td class="p-2">${r.note||''}</td></tr>`).join('');
  const incSum=incRows.reduce((s,r)=>s+Number(r.amount),0), expSum=expRows.reduce((s,r)=>s+Number(r.amount),0);
  $('histTotals').textContent=`Gelir: ‚Ç∫${fmt(incSum)} | Gider: ‚Ç∫${fmt(expSum)} | Fark: ‚Ç∫${fmt(incSum-expSum)}`;
}

/* REPORT */
document.getElementById('refreshReport').onclick=refreshReport;
async function refreshReport(){
  const d=todayStr();
  const base=supa.from('entries').select('method,amount').eq('tenant_id',TENANT_ID).eq('at_date',d);
  const [inc,exp]=await Promise.all([base.eq('kind','income'),base.eq('kind','expense')]);
  const incRows=inc.data||[], expRows=exp.data||[];
  let cash=0,card=0; incRows.forEach(r=>r.method==='cash'?cash+=+r.amount:card+=+r.amount);
  const expense=expRows.reduce((s,r)=>s+Number(r.amount),0);
  $('repLines').innerHTML=[`Br√ºt Gelir: ‚Ç∫${fmt(cash+card)} (Nakit: ‚Ç∫${fmt(cash)} | Kart: ‚Ç∫${fmt(card)})`,`Toplam Gider: ‚Ç∫${fmt(expense)}`,`Kasa Farkƒ±: ‚Ç∫${fmt(cash+card-expense)}`].map(l=>`<div>‚Ä¢ ${l}</div>`).join('');
}

/* Oturum varsa devam et */
(async()=>{const s=await supa.auth.getSession(); if(s.data.session){await afterLogin();}})();
</script>

</body>
</html>


