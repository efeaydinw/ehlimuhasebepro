<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ehlizade Muhasebe – Pro (Offline)</title>
<meta name="theme-color" content="#225c0a">
<style>
  :root{
    --primary:#225c0a;
    --accent:#e17703;
    --bg:#0f140f;
    --panel:#161d16;
    --border:#233e1a;
    --text:#eef0ee;
    --muted:#a7b1a6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;background:rgba(22,29,22,.8);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--border);z-index:10}
  header .bar{display:flex;gap:12px;align-items:center;padding:10px 16px}
  .logo{width:36px;height:36px;border-radius:10px;background:var(--primary);display:grid;place-items:center;font-weight:900}
  .brand{font-weight:900;color:var(--accent);letter-spacing:.3px}
  .badge{border:1px solid var(--border);background:#1a2418;border-radius:9999px;padding:3px 10px;font-size:12px}
  .btn{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:800}
  .btn.secondary{background:#1b221b}
  .btn.warn{background:#7a1b1b}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .field{flex:1 1 180px}
  label{display:block;margin-bottom:4px;color:#c5d0c5;font-size:12px}
  input[type="text"],input[type="number"],input[type="date"]{
    width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:#121812;color:var(--text);
  }
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{background:#1b221b;border:1px solid var(--border);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:800}
  .tab.active{background:var(--primary)}
  .chips{display:flex;gap:8px}
  .chip{border:1px solid var(--primary);padding:10px 16px;border-radius:9999px;cursor:pointer;font-weight:800}
  .chip.active{background:var(--accent);color:#000;border-color:var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
  th{background:#1b221b}
  tr:nth-child(odd) td{background:#141a14}
  .totals{font-size:13px;color:#cbd6cb}
  .hidden{display:none !important}
  .spacer{height:8px}
  .right{margin-left:auto}
  .toast{position:fixed;right:16px;bottom:16px;max-width:320px;display:none}
  .toast.show{display:block}
  .toast .box{background:#163c20;border:1px solid #2e8b57;padding:10px 12px;border-radius:10px;font-size:13px}
  .toast.bad .box{background:#441818;border-color:#a33}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
  .footer{opacity:.7;font-size:12px;margin-top:8px}
</style>
</head>
<body>
<header>
  <div class="bar container">
    <div class="logo">E</div>
    <div class="brand">Ehlizade Muhasebe</div>
    <div class="right badge" id="dbStatus">Hazır</div>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab active" data-tab="today">Bugün</button>
    <button class="tab" data-tab="expense">Gider</button>
    <button class="tab" data-tab="history">Geçmiş</button>
    <button class="tab" data-tab="report">Rapor</button>
    <button class="tab" data-tab="backup">Yedek</button>
  </div>

  <!-- TODAY -->
  <section id="tab-today">
    <div class="panel">
      <h3>Gelir Kaydı</h3>
      <div class="spacer"></div>
      <div class="row">
        <div class="field"><label>Tutar (₺)</label><input id="incAmount" type="number" step="0.01" min="0" placeholder="0,00"></div>
        <div class="field">
          <label>Ödeme</label>
          <div class="chips">
            <button class="chip active" id="incCash" data-val="cash">NAKİT</button>
            <button class="chip" id="incCard" data-val="card">KART</button>
          </div>
        </div>
        <div class="field"><label>Personel</label><input id="incStaff" type="text" placeholder="(opsiyonel)"></div>
        <div class="field" style="flex:2 1 280px"><label>Not</label><input id="incNote" type="text" placeholder="(opsiyonel)"></div>
        <div class="field" style="align-self:flex-end"><button id="saveIncome" class="btn">Kaydet</button></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="panel">
      <div class="row" style="align-items:center">
        <h3>Bugünkü Gelirler</h3>
        <div id="incTotals" class="totals right">Nakit: ₺0,00 | Kart: ₺0,00 | Toplam: ₺0,00</div>
      </div>
      <div class="spacer"></div>
      <div class="overflow">
        <table>
          <thead><tr><th>Saat</th><th>Yöntem</th><th>Tutar</th><th>Personel</th><th>Not</th><th>İşlem</th></tr></thead>
          <tbody id="incBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- EXPENSE -->
  <section id="tab-expense" class="hidden">
    <div class="panel">
      <h3>Gider Kaydı</h3>
      <div class="spacer"></div>
      <div class="row">
        <div class="field"><label>Tutar (₺)</label><input id="expAmount" type="number" step="0.01" min="0" placeholder="0,00"></div>
        <div class="field">
          <label>Ödeme</label>
          <div class="chips">
            <button class="chip active" id="expCash" data-val="cash">NAKİT</button>
            <button class="chip" id="expCard" data-val="card">KART</button>
          </div>
        </div>
        <div class="field"><label>Personel</label><input id="expStaff" type="text" placeholder="(opsiyonel)"></div>
        <div class="field" style="flex:2 1 280px"><label>Not</label><input id="expNote" type="text" placeholder="(opsiyonel)"></div>
        <div class="field" style="align-self:flex-end"><button id="saveExpense" class="btn">Kaydet</button></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="panel">
      <div class="row" style="align-items:center">
        <h3>Bugünkü Giderler</h3>
        <div id="expTotals" class="totals right">Nakit: ₺0,00 | Kart: ₺0,00 | Toplam: ₺0,00</div>
      </div>
      <div class="spacer"></div>
      <div class="overflow">
        <table>
          <thead><tr><th>Saat</th><th>Yöntem</th><th>Tutar</th><th>Personel</th><th>Not</th><th>İşlem</th></tr></thead>
          <tbody id="expBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="tab-history" class="hidden">
    <div class="panel">
      <div class="row" style="align-items:flex-end">
        <div class="field"><label>Tarih</label><input id="histDate" type="date"></div>
        <button id="loadHistory" class="btn">Yükle</button>
        <div class="totals right" id="histTotals">Gelir: ₺0,00 | Gider: ₺0,00 | Fark: ₺0,00</div>
      </div>
    </div>

    <div class="spacer"></div>
    <div class="grid2">
      <div class="panel">
        <h3>Gelir</h3>
        <div class="spacer"></div>
        <table><thead><tr><th>Saat</th><th>Yöntem</th><th>Tutar</th><th>Personel</th><th>Not</th></tr></thead>
        <tbody id="histInc"></tbody></table>
      </div>
      <div class="panel">
        <h3>Gider</h3>
        <div class="spacer"></div>
        <table><thead><tr><th>Saat</th><th>Yöntem</th><th>Tutar</th><th>Personel</th><th>Not</th></tr></thead>
        <tbody id="histExp"></tbody></table>
      </div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="tab-report" class="hidden">
    <div class="panel">
      <h3>Gün Sonu Raporu</h3>
      <div class="spacer"></div>
      <div id="repLines" class="row" style="gap:6px;flex-direction:column"></div>
      <button id="refreshReport" class="btn" style="margin-top:8px">Yenile</button>
      <div class="footer">Not: Bu rapor brüt gelir ve gider toplamlarını gösterir.</div>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="tab-backup" class="hidden">
    <div class="panel">
      <h3>Yedek / Aktarım</h3>
      <div class="spacer"></div>
      <div class="row">
        <button id="btnExport" class="btn">Tüm Veriyi Dışa Aktar (JSON indir)</button>
        <label class="btn secondary">
          Yedekten Yükle
          <input id="importFile" type="file" accept=".json,application/json" style="display:none">
        </label>
        <button id="btnClear" class="btn warn right">Tüm Veriyi Sil (Dikkat!)</button>
      </div>
      <div class="footer">Veriler bu cihazda güvenle IndexedDB içinde saklanır. Dışa aktararak yedek almayı unutmayın.</div>
    </div>
  </section>
</div>

<!-- Toast -->
<div class="toast" id="toast"><div class="box" id="toastBox">Mesaj</div></div>

<script>
(function(){
'use strict';

// ====== Helpers ======
const $ = (id)=>document.getElementById(id);
const tShow=(m,ok=true)=>{const t=$('toast'),b=$('toastBox');b.textContent=m;t.classList.remove('bad');if(!ok)t.classList.add('bad');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)};
const fmt = (n)=> Number(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
const todayStr=()=>new Date().toISOString().slice(0,10);
const timeStr=(ts)=> new Date(ts).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});

// ====== Simple IndexedDB wrapper ======
const DB_NAME = 'ehlizade-db';
const DB_VER = 1;
let db;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains('entries')){
        const st = db.createObjectStore('entries',{keyPath:'id'});
        st.createIndex('at_date','at_date',{unique:false});
        st.createIndex('kind','kind',{unique:false});
        st.createIndex('at_date_kind',['at_date','kind'],{unique:false});
      }
      if(!db.objectStoreNames.contains('settings')){
        db.createObjectStore('settings',{keyPath:'key'});
      }
    };
    req.onsuccess = ()=>{db=req.result; $('dbStatus').textContent='Hazır'; resolve();};
    req.onerror = ()=>{ $('dbStatus').textContent='DB Hatası'; reject(req.error); };
  });
}

function tx(storeNames,mode='readonly'){
  return db.transaction(storeNames, mode);
}

function addEntry(entry){
  return new Promise((resolve,reject)=>{
    const t = tx(['entries'],'readwrite');
    t.objectStore('entries').put(entry);
    t.oncomplete=()=>resolve(entry);
    t.onerror=()=>reject(t.error);
  });
}

function deleteEntry(id){
  return new Promise((resolve,reject)=>{
    const t = tx(['entries'],'readwrite');
    t.objectStore('entries').delete(id);
    t.oncomplete=()=>resolve();
    t.onerror=()=>reject(t.error);
  });
}

function getEntriesByDate(dateStr, kind){ // kind optional
  return new Promise((resolve,reject)=>{
    const t = tx(['entries'],'readonly');
    const st = t.objectStore('entries');
    const idx = st.index(kind? 'at_date_kind':'at_date');
    const key = kind? [dateStr, kind] : dateStr;
    const req = idx.getAll(IDBKeyRange.only(key));
    req.onsuccess = ()=>resolve(req.result||[]);
    req.onerror = ()=>reject(req.error);
  });
}

function getAllEntries(){
  return new Promise((resolve,reject)=>{
    const t = tx(['entries'],'readonly');
    const st = t.objectStore('entries');
    const req = st.getAll();
    req.onsuccess=()=>resolve(req.result||[]);
    req.onerror=()=>reject(req.error);
  });
}

function clearAll(){
  return new Promise((resolve,reject)=>{
    const t = tx(['entries','settings'],'readwrite');
    t.objectStore('entries').clear();
    t.objectStore('settings').clear();
    t.oncomplete=()=>resolve();
    t.onerror=()=>reject(t.error);
  });
}

function setSetting(key,value){
  return new Promise((resolve,reject)=>{
    const t = tx(['settings'],'readwrite');
    t.objectStore('settings').put({key,value});
    t.oncomplete=()=>resolve();
    t.onerror=()=>reject(t.error);
  });
}
function getSetting(key){
  return new Promise((resolve,reject)=>{
    const t = tx(['settings'],'readonly');
    const req = t.objectStore('settings').get(key);
    req.onsuccess=()=>resolve(req.result?req.result.value:null);
    req.onerror=()=>reject(req.error);
  });
}

// ====== UI logic ======
function chipGroup(a,b){ a.classList.add('active'); a.onclick=()=>{a.classList.add('active'); b.classList.remove('active')}; b.onclick=()=>{b.classList.add('active'); a.classList.remove('active')}; }
chipGroup($('incCash'),$('incCard'));
chipGroup($('expCash'),$('expCard'));

// Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
    $('tab-'+tab).classList.remove('hidden');
  };
});
$('histDate').value = todayStr();

// Save income
$('saveIncome').onclick = async ()=>{
  try{
    const amount = Number($('incAmount').value);
    if(!amount || amount<=0){ tShow('Geçerli tutar gir',false); return; }
    const method = $('incCash').classList.contains('active') ? 'cash' : 'card';
    const entry = {
      id: crypto.randomUUID(),
      kind:'income', method, amount,
      staff: $('incStaff').value.trim() || null,
      note: $('incNote').value.trim() || null,
      at_time: new Date().toISOString(),
      at_date: todayStr()
    };
    await addEntry(entry);
    $('incAmount').value=''; $('incNote').value='';
    tShow('Gelir eklendi');
    await loadToday();
    await refreshReport();
  }catch(e){ tShow('Kayıt hatası',false); }
};

// Save expense
$('saveExpense').onclick = async ()=>{
  try{
    const amount = Number($('expAmount').value);
    if(!amount || amount<=0){ tShow('Geçerli tutar gir',false); return; }
    const method = $('expCash').classList.contains('active') ? 'cash' : 'card';
    const entry = {
      id: crypto.randomUUID(),
      kind:'expense', method, amount,
      staff: $('expStaff').value.trim() || null,
      note: $('expNote').value.trim() || null,
      at_time: new Date().toISOString(),
      at_date: todayStr()
    };
    await addEntry(entry);
    $('expAmount').value=''; $('expNote').value='';
    tShow('Gider eklendi');
    await loadExpenseToday();
    await refreshReport();
  }catch(e){ tShow('Kayıt hatası',false); }
};

function rowActions(id){
  const btn = document.createElement('button');
  btn.className='btn secondary'; btn.textContent='Sil';
  btn.onclick = async()=>{
    if(!confirm('Kayıt silinsin mi?')) return;
    try{ await deleteEntry(id); tShow('Silindi'); await loadToday(); await loadExpenseToday(); await refreshReport(); }
    catch(e){ tShow('Silinemedi',false); }
  };
  const wrap = document.createElement('div'); wrap.appendChild(btn); return wrap;
}

// Load today's incomes
async function loadToday(){
  try{
    const rows = await getEntriesByDate(todayStr(),'income');
    const body = $('incBody'); body.innerHTML='';
    let cash=0, card=0;
    rows.sort((a,b)=> b.at_time.localeCompare(a.at_time));
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${timeStr(r.at_time)}</td><td>${r.method==='cash'?'Nakit':'Kart'}</td>
                      <td>₺${fmt(r.amount)}</td><td>${r.staff||''}</td><td>${r.note||''}</td><td></td>`;
      tr.lastChild.appendChild(rowActions(r.id));
      body.appendChild(tr);
      if(r.method==='cash') cash+=Number(r.amount); else card+=Number(r.amount);
    }
    $('incTotals').textContent = `Nakit: ₺${fmt(cash)} | Kart: ₺${fmt(card)} | Toplam: ₺${fmt(cash+card)}`;
  }catch(e){ /* no-op */ }
}

// Load today's expenses
async function loadExpenseToday(){
  try{
    const rows = await getEntriesByDate(todayStr(),'expense');
    const body = $('expBody'); body.innerHTML='';
    let cash=0, card=0;
    rows.sort((a,b)=> b.at_time.localeCompare(a.at_time));
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${timeStr(r.at_time)}</td><td>${r.method==='cash'?'Nakit':'Kart'}</td>
                      <td>₺${fmt(r.amount)}</td><td>${r.staff||''}</td><td>${r.note||''}</td><td></td>`;
      tr.lastChild.appendChild(rowActions(r.id));
      body.appendChild(tr);
      if(r.method==='cash') cash+=Number(r.amount); else card+=Number(r.amount);
    }
    $('expTotals').textContent = `Nakit: ₺${fmt(cash)} | Kart: ₺${fmt(card)} | Toplam: ₺${fmt(cash+card)}`;
  }catch(e){ /* no-op */ }
}

// History
$('loadHistory').onclick = loadHistory;
async function loadHistory(){
  try{
    const d = $('histDate').value || todayStr();
    const inc = await getEntriesByDate(d,'income');
    const exp = await getEntriesByDate(d,'expense');
    const ib=$('histInc'), eb=$('histExp'); ib.innerHTML=''; eb.innerHTML='';
    let incSum=0, expSum=0;
    inc.sort((a,b)=> b.at_time.localeCompare(a.at_time));
    exp.sort((a,b)=> b.at_time.localeCompare(a.at_time));
    for(const r of inc){ incSum+=Number(r.amount); const tr=document.createElement('tr'); tr.innerHTML=`<td>${timeStr(r.at_time)}</td><td>${r.method==='cash'?'Nakit':'Kart'}</td><td>₺${fmt(r.amount)}</td><td>${r.staff||''}</td><td>${r.note||''}</td>`; ib.appendChild(tr); }
    for(const r of exp){ expSum+=Number(r.amount); const tr=document.createElement('tr'); tr.innerHTML=`<td>${timeStr(r.at_time)}</td><td>${r.method==='cash'?'Nakit':'Kart'}</td><td>₺${fmt(r.amount)}</td><td>${r.staff||''}</td><td>${r.note||''}</td>`; eb.appendChild(tr); }
    $('histTotals').textContent = `Gelir: ₺${fmt(incSum)} | Gider: ₺${fmt(expSum)} | Fark: ₺${fmt(incSum-expSum)}`;
  }catch(e){ /* no-op */ }
}

// Report
$('refreshReport').onclick = refreshReport;
async function refreshReport(){
  try{
    const d = todayStr();
    const inc = await getEntriesByDate(d,'income');
    const exp = await getEntriesByDate(d,'expense');
    let cash=0, card=0, ex=0;
    for(const r of inc){ if(r.method==='cash') cash+=Number(r.amount); else card+=Number(r.amount); }
    for(const r of exp){ ex+=Number(r.amount); }
    const box = $('repLines');
    box.innerHTML = [`Brüt Gelir: ₺${fmt(cash+card)}`,
                     `— Nakit: ₺${fmt(cash)}`,
                     `— Kart: ₺${fmt(card)}`,
                     `Toplam Gider: ₺${fmt(ex)}`,
                     `Kasa Farkı: ₺${fmt(cash+card-ex)}`].map(s=>`<div>• ${s}</div>`).join('');
  }catch(e){ /* no-op */ }
}

// Backup / Restore
$('btnExport').onclick = async ()=>{
  try{
    const data = await getAllEntries();
    const payload = { exported_at: new Date().toISOString(), entries: data };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ehlizade_yedek_'+todayStr()+'.json';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    tShow('Yedek indirildi');
  }catch(e){ tShow('Yedek alınamadı',false); }
};

$('importFile').onchange = async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const json = JSON.parse(text);
    const list = Array.isArray(json.entries) ? json.entries : [];
    let added=0;
    for(const r of list){
      // Zaten varsa atla
      try{ await addEntry(r); added++; }catch(err){ /* duplicate or other */ }
    }
    tShow('Yedek yüklendi: '+added+' kayıt');
    await loadToday(); await loadExpenseToday(); await refreshReport();
  }catch(e){ tShow('Yedek okunamadı',false); }
};

$('btnClear').onclick = async()=>{
  if(!confirm('Tüm veriler silinsin mi? Bu işlem geri alınamaz.')) return;
  try{ await clearAll(); tShow('Veriler silindi'); await loadToday(); await loadExpenseToday(); await refreshReport(); }
  catch(e){ tShow('Silinemedi',false); }
};

// Init
openDB().then(async()=>{
  $('histDate').value = todayStr();
  await loadToday(); await loadExpenseToday(); await loadHistory(); await refreshReport();
}).catch(()=>tShow('Veritabanı açılamadı',false));

})(); // IIFE
</script>
</body>
</html>
